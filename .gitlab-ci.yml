include:
  - template: 'Workflows/Branch-Pipelines.gitlab-ci.yml'

stages:
  - ip
  - sim
  - synth

variables:
  GIT_STRATEGY: clone
  SEED: 0
  RANDOMIZE_SEED: 0

.common:
  image: $CI_REGISTRY/ht/xilinx-tools-docker:43194-gd5ce900f
  before_script:
    - git clone https://gitlab.es.net/ht/open-nic-shell.git
    - make -s config BOARD_REPO=$CI_PROJECT_DIR/open-nic-shell/board_files/Xilinx
    - if [ $RANDOMIZE_SEED -gt 0 ]; then export SEED=$RANDOM; fi
    - echo "Running pipeline with SEED $SEED..."
  variables:
    XILINXD_LICENSE_FILE: "2100@dmv.es.net"
    # Required to keep click python module happy
    LC_ALL: C.UTF-8
    LANG: C.UTF-8
    GIT_SUBMODULE_STRATEGY: recursive

ip:
  stage: ip
  extends: .common
  tags:
    - ht-sim
  script:
    - make -s -C src synth COMPONENT=fifo.ip
    - make -s -C src synth COMPONENT=axi4s.ip
  artifacts:
    paths: [.out]

sim:
  stage: sim
  extends: .common
  tags:
    - ht-sim
  script:
    - make -s -C src/std/tests/regression SEED=$SEED
    - grep 'PASSED.*suites passing' src/std/tests/regression/run_$SEED/sim.log
    - make -s -C src/sync/tests/regression SEED=$SEED
    - grep 'PASSED.*suites passing' src/sync/tests/regression/run_$SEED/sim.log
    - make -s -C src/arb/tests/regression SEED=$SEED
    - grep 'PASSED.*suites passing' src/arb/tests/regression/run_$SEED/sim.log
    - make -s -C src/mem/tests/regression SEED=$SEED
    - grep 'PASSED.*suites passing' src/mem/tests/regression/run_$SEED/sim.log
    - make -s -C src/reg/proxy/tests/regression SEED=$SEED
    - grep 'PASSED.*suites passing' src/reg/proxy/tests/regression/run_$SEED/sim.log
    - make -s -C src/reg/endian/tests/regression SEED=$SEED
    - grep 'PASSED.*suites passing' src/reg/endian/tests/regression/run_$SEED/sim.log
    - make -s -C src/reg/example/tests/regression SEED=$SEED
    - grep 'PASSED.*suites passing' src/reg/example/tests/regression/run_$SEED/sim.log
    - make -s -C src/fifo/tests/regression SEED=$SEED
    - grep 'PASSED.*suites passing' src/fifo/tests/regression/run_$SEED/sim.log
    - make -s -C src/packet/tests/regression SEED=$SEED
    - grep 'PASSED.*suites passing' src/packet/tests/regression/run_$SEED/sim.log
    - make -s -C src/axi4l/tests/regression SEED=$SEED
    - grep 'PASSED.*suites passing' src/axi4l/tests/regression/run_$SEED/sim.log
    - make -s -C src/axi4s/tests/regression SEED=$SEED
    - grep 'PASSED.*suites passing' src/axi4s/tests/regression/run_$SEED/sim.log
    - make -s -C src/crc/tests/regression SEED=$SEED
    - grep 'PASSED.*suites passing' src/crc/tests/regression/run_$SEED/sim.log
    - make -s -C src/db/tests/regression SEED=$SEED
    - grep 'PASSED.*suites passing' src/db/tests/regression/run_$SEED/sim.log
    - make -s -C src/htable/tests/regression SEED=$SEED
    - grep 'PASSED.*suites passing' src/htable/tests/regression/run_$SEED/sim.log
    - make -s -C src/state/tests/regression SEED=$SEED
    - grep 'PASSED.*suites passing' src/state/tests/regression/run_$SEED/sim.log
    - make -s -C src/timer/tests/regression SEED=$SEED
    - grep 'PASSED.*suites passing' src/timer/tests/regression/run_$SEED/sim.log
  artifacts:
    name: "artifacts.$CI_PROJECT_NAME.$CI_JOB_NAME.$CI_PIPELINE_ID"
    reports:
      junit:
        - src/*/tests/regression/run_*/tests.xml
    when: always
  needs: [ip]
  timeout: 3h

synth:
  stage: synth
  extends: .common
  tags:
    - ht-sim
  parallel:
    matrix:
      - COMPONENT: [sync, mem, fifo, axi4l, db, htable, state]
  script:
    # Run all build jobs in specified component library
    - find src/$COMPONENT/build -mindepth 1 -maxdepth 1 -type d -name '[^\.]*' -exec make -s -C {} \;
  artifacts:
    when: always
    paths: [.out/$COMPONENT/build]
    reports:
      junit:
        - .out/$COMPONENT/build/**/*.summary.xml
  needs: [ip]

